<!DOCTYPE html>
<html lang="en">
  <head>   <!-- Force navigation to Flask server for Jinja processing -->
   <script>
     if (window.location.pathname !== '/dashboard') {
       window.location.href = window.location.origin + '/dashboard';
     }
   </script>    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
    <title>Starlink &amp; Wifi Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.9.2/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.9.2/mapbox-gl.css' rel='stylesheet' />    <!-- Minimal inline CSS for expanded layout -->
    <style>
      /* Mobile-first responsive design improvements */
      * {
        box-sizing: border-box;
      }
      
      /* If your style.css already defines .chart-grid with multiple columns,
         this class will override it to show a single column when "expanded" */
      .chart-grid.expanded {
        grid-template-columns: 1fr !important;
      }
      /* Optionally add some spacing so stacked charts look nice */
      .chart-grid.expanded .chart-card {
        margin-bottom: 20px;
      }
      /* Attempt to make default chart cards wider */
      .chart-grid .chart-card {
        min-width: 280px; /* Reduced for mobile */
        margin: 15px; /* Added margin for spacing between cards */
      }
      
      /* Mobile responsive chart card adjustments */
      @media (max-width: 768px) {
        .chart-grid .chart-card {
          min-width: unset;
          margin: 10px 0;
        }
      }
      
      .chart-graph {
        height: 280px; /* Increased graph height */
      }
      
      /* Mobile responsive chart graph height */
      @media (max-width: 768px) {
        .chart-graph {
          height: 200px;
        }
      }

      @media (max-width: 480px) {
        .chart-graph {
          height: 150px;
        }
      }.dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 20px;
        background-color: #1e1e2e;
        color: #ffffff;
        border-radius: 8px 8px 0 0;
        flex-wrap: wrap;
        gap: 10px;
      }
      
      /* Mobile responsive dashboard header */
      @media (max-width: 768px) {
        .dashboard-header {
          flex-direction: column;
          text-align: center;
          padding: 15px;
        }
      }
      
      @media (max-width: 480px) {
        .dashboard-header {
          padding: 10px;
        }
      }
      
      .dashboard-title {
        font-size: 1.5rem;
        font-weight: 500;
      }
      
      /* Mobile responsive dashboard title */
      @media (max-width: 768px) {
        .dashboard-title {
          font-size: 1.3rem;
          margin-bottom: 10px;
        }
      }
      
      @media (max-width: 480px) {
        .dashboard-title {
          font-size: 1.2rem;
        }
      }      .logout-btn {
        background-color: #ff4757;
        color: #ffffff;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: background-color 0.3s ease;
      }
      
      /* Mobile responsive logout button */
      @media (max-width: 768px) {
        .logout-btn {
          padding: 10px 20px;
          font-size: 1rem;
        }
      }
      
      @media (max-width: 480px) {
        .logout-btn {
          padding: 8px 16px;
          font-size: 0.9rem;
          width: 100%;
          max-width: 150px;
        }
      }
      
      .logout-btn:hover {
        background-color: #e84118;
      }
    </style>
  </head>

  <body>
    <div class="dashboard">
      <!-- Header / Subscription Info -->
      <div class="dashboard-header">
        <div class="dashboard-title">Starlink Dashboard</div>
        <button id="logoutBtn" class="logout-btn">Logout</button>
      </div>

      <div class="dashboard-header">
        <h1>Subscription</h1>
        <!-- Dropdown for service lines (if more than one exist) -->
        <div id="serviceLineWrapper" style="margin-top: 10px; display: none">
          <label for="serviceLineDropdown" style="margin-right: 8px"
            >Select Service Line:</label
          >
          <select
            id="serviceLineDropdown"
            style="padding: 4px 8px; font-size: 0.9rem"
          ></select>
        </div>
        <p class="subscription-id" style="margin-top: 5px">Loading...</p>
      </div>

      <!-- First row: Nickname & Service Plan -->
      <div class="row">
        <div class="box">
          <h2 class="box-title">Nickname</h2>
          <div class="box-content box-nickname">Loading...</div>
        </div>
        <div class="box">
          <h2 class="box-title">
            Service Plan
            <span id="serviceStatus" class="status-active">Loading...</span>
          </h2>
          <div class="box-content box-plan">Residential</div>
        </div>
      </div>

      <!-- Second row: Service Location & Total Data Usage -->
      <div class="row">
        <!-- Left box: Map & Address -->
        <div class="box">
          <h2 class="box-title">Service Location</h2>
          <div class="box-content box-address" style="margin-bottom: 10px">
            Loading...
          </div>
          <div class="map-area">
            <div
              id="map"
              style="width: 100%; height: 300px; border-radius: 8px;"
            ></div>
          </div>
        </div>

        <!-- Right box: Data Usage & Chart (billing cycles) -->
        <div class="box" id="billingDataBox" style="display: none">
          <h2 class="box-title">Total Data Usage</h2>
          <div class="box-content box-total-usage" style="font-size: 0.6rem">
            0 GB
          </div>
          <div class="month-tabs" id="monthTabs"></div>
          <div class="usage-chart-area">
            <canvas id="usageChart"></canvas>
          </div>
          <div class="box-content" style="color: #ccc; margin-top: 10px">
            <strong id="legendTotal">0 GB</strong> (Cycle Total)
          </div>
          <div class="usage-footnote">
            Data usage is tracked in UTC time, which may differ from your local
            time.<br />
            Refer to your statement for accurate billing information.
          </div>
        </div>
      </div>
    </div>

    <!-- Device Panel Container -->
    <div class="container">
      <div class="title">Devices</div>
      <div class="devices">
        <div class="device-list">
          <div class="device-item" id="btn-starlink">
            <span class="device-icon">&#128225;</span>
            STARLINK
            <span class="green-dot"></span>
          </div>
          <div class="device-item" id="btn-wifi">
            <span class="device-icon">&#128246;</span>
            WIFI
            <span class="green-dot"></span>
          </div>
        </div>
        <div class="device-container">
          <!-- STARLINK PANEL -->
          <div class="device-panel" id="starlinkPanel">
            <div
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 1rem;
              "
            >
              <h2 style="margin: 0">STARLINK</h2>
              <a
                href="https://paystack.com/pay/ecubeghana"
                target="_blank"
                style="
                  background: #ff9800;
                  color: #fff;
                  padding: 6px 12px;
                  text-decoration: none;
                  border-radius: 4px;
                  font-weight: 500;
                "
                >Payment Method</a
              >
            </div>
            <div class="device-details">
              <div class="detail-grid">
                <div>
                  <div>
                    <strong>Starlink ID:</strong>
                    <span id="starlinkId">Loading...</span>
                  </div>
                  <div>
                    <strong>Software Version:</strong>
                    <span id="starlinkSw">Loading...</span>
                  </div>
                </div>
                <div>
                  <div>
                    <strong>Serial Number:</strong>
                    <span id="dishSerial">Loading...</span>
                  </div>
                  <div>
                    <strong>Kit Number:</strong>
                    <span id="kitSerial">Loading...</span>
                  </div>
                </div>
              </div>
            </div>
            <div class="charts">
              <div class="chart-header">
                <div class="time-range-tabs">
                  <button class="active">15 Minutes</button>
                  <button>3 Hours</button>
                  <button>1 Day</button>
                  <button>7 Days</button>
                  <button>30 Days</button>
                </div>
                <div class="chart-buttons">
                  <!-- Added IDs for expand/collapse & CSV -->
                  <button id="starlinkDownloadCsvBtn">Download CSV</button>
                  <button id="starlinkExpandBtn">Expand Charts</button>
                </div>
              </div>
              <div class="chart-grid">
                <!-- Downlink Throughput -->
                <div class="chart-card">
                  <div class="chart-title">
                    Downlink Throughput <span title="Info">&#9432;</span>
                  </div>
                  <div class="chart-stats" id="downlinkStats">
                    Min 0 Mbps · Max 0 Mbps · Last 0 Mbps
                  </div>
                  <div class="chart-graph">
                    <canvas id="downlinkChart"></canvas>
                  </div>
                </div>
                <!-- Uplink Throughput -->
                <div class="chart-card">
                  <div class="chart-title">
                    Uplink Throughput <span title="Info">&#9432;</span>
                  </div>
                  <div class="chart-stats" id="uplinkStats">
                    Min 0 Mbps · Max 0 Mbps · Last 0 Mbps
                  </div>
                  <div class="chart-graph">
                    <canvas id="uplinkChart"></canvas>
                  </div>
                </div>
                <!-- Latency -->
                <div class="chart-card">
                  <div class="chart-title">
                    Latency <span title="Info">&#9432;</span>
                  </div>
                  <div class="chart-stats" id="latencyStats">
                    Min 0 ms · Max 0 ms · Last 0 ms
                  </div>
                  <div class="chart-graph">
                    <canvas id="latencyChart"></canvas>
                  </div>
                </div>
                <!-- Ping Drop Rate -->
                <div class="chart-card">
                  <div class="chart-title">
                    Ping Drop Rate <span title="Info">&#9432;</span>
                  </div>
                  <div class="chart-stats" id="pingDropStats">
                    Min 0% · Max 0% · Last 0%
                  </div>
                  <div class="chart-graph">
                    <canvas id="pingDropChart"></canvas>
                  </div>
                </div>
                <!-- Signal Quality -->
                <div class="chart-card">
                  <div class="chart-title">
                    Signal Quality <span title="Info">&#9432;</span>
                  </div>
                  <div class="chart-stats" id="signalStats">
                    Min 0% · Max 0% · Last 0%
                  </div>
                  <div class="chart-graph">
                    <canvas id="signalChart"></canvas>
                  </div>
                </div>
                <!-- Obstruction -->
                <div class="chart-card">
                  <div class="chart-title">
                    Obstruction <span title="Info">&#9432;</span>
                  </div>
                  <div class="chart-stats" id="obstructionStats">
                    Min 0% · Max 0% · Last 0%
                  </div>
                  <div class="chart-graph">
                    <canvas id="obstructionChart"></canvas>
                  </div>
                </div>
              </div>
              <!-- end .chart-grid -->
            </div>
            <!-- end .charts -->
          </div>
          <!-- WIFI PANEL -->
          <div class="device-panel" id="wifiPanel">
            <div class="device-details">
              <div class="detail-grid">
                <div>
                  <div>
                    <strong>Router ID:</strong>
                    <span id="routerId">Loading...</span>
                  </div>
                </div>
                <div>
                  <div>
                    <strong>Software Version:</strong>
                    <span id="routerSw">Loading...</span>
                  </div>
                </div>
              </div>
            </div>
            <div class="charts">
              <div class="chart-header">
                <div class="time-range-tabs">
                  <button class="active">15 Minutes</button>
                  <button>3 Hours</button>
                  <button>1 Day</button>
                  <button>7 Days</button>
                  <button>30 Days</button>
                </div>
                <div class="chart-buttons">
                  <!-- Added IDs for expand/collapse & CSV -->
                  <button id="wifiDownloadCsvBtn">Download CSV</button>
                  <button id="wifiExpandBtn">Expand Charts</button>
                </div>
              </div>
              <div class="chart-grid">
                <div class="chart-card">
                  <div class="chart-title">
                    Latency <span title="Info">&#9432;</span>
                  </div>
                  <div class="chart-stats" id="wifiLatencyStats">
                    Min 0ms · Max 0ms · Last 0ms
                  </div>
                  <div class="chart-graph">
                    <canvas id="wifiLatencyChart"></canvas>
                  </div>
                </div>
                
                <div class="chart-card">
                  <div class="chart-title">
                    Ping Drop Rate <span title="Info">&#9432;</span>
                  </div>
                  <div class="chart-stats" id="wifiPingDropStats">
                    Min 0% · Max 0% · Last 0%
                  </div>
                  <div class="chart-graph">
                    <canvas id="wifiPingDropChart"></canvas>
                  </div>
                </div>                
              </div>
            </div>
          </div>
        </div>
        <!-- end device-container -->
      </div>
      <!-- end devices -->
    </div>
    <!-- end container -->

    <!-- SCRIPTS -->
    <script type="module">
      /************************************************************
       * MAPBOX: Initialize map by geocoding the service address.
       ************************************************************/
      mapboxgl.accessToken =
        "pk.eyJ1IjoiaGFzc2FuYWxpODEyMTMiLCJhIjoiY203cnc0aHNqMDl5NzJqcjI0enR0dnJlMCJ9.V5Cg2-AtLLgZTgfTmijnsQ";

      // Place this at the top of your script (before initializeMap)
let mapboxMap = null;
let mapboxMarker = null;

async function initializeMap(address) {
  try {
    const response = await fetch(
      `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(address)}.json?access_token=${mapboxgl.accessToken}`
    );
    console.log("Mapbox geocoding response for", address, ":", response); // Debugging line
    const data = await response.json();
    if (!data.features || !data.features.length) {
      console.warn("Mapbox: No geocoding results found.");
      return;
    }
    console.log("Mapbox geocoding data for", address, ":", data); // Debugging line

    const [lng, lat] = data.features[0].center;
    console.log("Mapbox center for", address, "is", lng, lat); // Debugging line

    // Always remove the old map and marker, then create a new map
    if (mapboxMap) {
      mapboxMap.remove();
      mapboxMap = null;
      mapboxMarker = null;
    }

    mapboxMap = new mapboxgl.Map({
      container: "map",
      style: "mapbox://styles/mapbox/streets-v11",
      center: [lng, lat],
      zoom: 14,
    });
    mapboxMarker = new mapboxgl.Marker().setLngLat([lng, lat]).addTo(mapboxMap);
    mapboxMap.addControl(new mapboxgl.NavigationControl());
  } catch (error) {
    console.error("Error initializing map:", error);
  }
}

      /************************************************************
       * Fetch dashboard data from the server
       * Uses stored idToken for authentication
       ************************************************************/
      async function fetchDashboardData(serviceLine, idToken) {
        try {          const response = await fetch(
            `/api/dashboard-data/${serviceLine}`,
            {
              method: "GET",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${idToken}`,
              },
            }
          );
          if (!response.ok) {
            throw new Error(
              `Error fetching data for ${serviceLine}: ${response.statusText}`
            );
          }
          return await response.json();
        } catch (error) {
          console.error("Error in fetchDashboardData:", error);
          throw error;
        }
      }

      // Helper function to parse HEX or RGB/RGBA color strings to R, G, B components
      function parseColorToRgb(colorString) {
          colorString = String(colorString).trim(); // Ensure it\'s a string and trim whitespace

          if (colorString.startsWith("#")) {
              let hex = colorString.slice(1);
              // Validate hex string (3 or 6 characters)
              if (!/^[0-9A-Fa-f]{3}$|^[0-9A-Fa-f]{6}$/.test(hex)) {
                  console.warn(`Invalid hex string in parseColorToRgb: ${colorString}`);
                  return null;
              }
              // Convert 3-digit hex to 6-digit
              if (hex.length === 3) {
                  hex = hex.split('').map(char => char + char).join('');
              }
              const r = parseInt(hex.slice(0, 2), 16);
              const g = parseInt(hex.slice(2, 4), 16);
              const b = parseInt(hex.slice(4, 6), 16);
              return { r, g, b };
          } else if (colorString.startsWith("rgb")) { // Handles rgb() and rgba()
              // Regex to extract R, G, B values from rgb() or rgba()
              const match = colorString.match(/rgba?\\((\\d{1,3}),\\s*(\\d{1,3}),\\s*(\\d{1,3})(?:,\\s*[\\d.]+)?\\)/);
              if (match) {
                  const r = parseInt(match[1]);
                  const g = parseInt(match[2]);
                  const b = parseInt(match[3]);
                  // Validate RGB values (0-255)
                  if (r >= 0 && r <= 255 && g >= 0 && g <= 255 && b >= 0 && b <= 255) {
                      return { r, g, b };
                  } else {
                      console.warn(`Invalid RGB values in parseColorToRgb: ${colorString}`);
                      return null;
                  }
              }
              console.warn(`Invalid rgb/rgba string format in parseColorToRgb: ${colorString}`);
              return null;
          }
          console.warn(`Unknown color format in parseColorToRgb: ${colorString}`);
          return null; // Unknown format
      }

      // Helper function to take a base color (HEX or RGB/RGBA) and return an RGBA string with a specific alpha
      function getColorWithAlpha(baseColor, alpha) {
          const rgb = parseColorToRgb(baseColor);
          if (rgb) {
              return `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, ${alpha})`;
          }
          // Fallback if color parsing fails, using a default color
          console.warn(`Failed to parse baseColor \'${baseColor}\' in getColorWithAlpha. Using fallback.`);
          return `rgba(75, 192, 192, ${alpha})`; // Example: Teal fallback
      }

      /************************************************************
       * Utility: Create a line chart with Chart.js
       ************************************************************/
      function createLineChart(ctx, label, dataLabels, dataValues, yAxisLabel = "", lineColor = "#4BC0C0") { // Default lineColor changed to HEX
        // Calculate min/max for better scaling
        let min = Math.min(...dataValues);
        let max = Math.max(...dataValues);
        // If all values are the same, set a reasonable range
        if (min === max) {
          min = min - (Math.abs(min * 0.1) || 1); // Adjust by 10% or 1 if min is 0
          max = max + (Math.abs(max * 0.1) || 1); // Adjust by 10% or 1 if max is 0
        }

        // const fillColor = hexToRgba(lineColor, 0.2); // lineColor is expected to be hex // OLD LINE
        const fillColor = getColorWithAlpha(lineColor, 0.2); // Use new global helper

        return new Chart(ctx, {
        type: "line",
        data: {
            labels: dataLabels,
            datasets: [{
                label: label,
                data: dataValues,
                fill: true,
                borderColor: lineColor,
                backgroundColor: fillColor,
                tension: 0.4, // Smoother curves
                borderWidth: 2, // Line thickness
                pointRadius: 0, // Hide points by default
                pointHoverRadius: 0, // Hide points on hover as well
                pointBackgroundColor: lineColor // Point color
              }
            ],
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                  ticks: {
                    color: "#ccc",
                    autoSkip: true, // Enable auto-skipping of labels
                    maxTicksLimit: 10, // Suggest a maximum number of ticks
                    maxRotation: 0, // Ensure labels are horizontal
                    minRotation: 0 // Ensure labels are horizontal
                  },
                  grid: {
                    color: "rgba(255,255,255,0.1)",
                    drawBorder: false
                  },
                  border: {
                    display: true,
                    color: '#ccc'
                  }
                },
                y: {
                    beginAtZero: false, // Reverted: Allow charts to not start at zero
                    suggestedMin: min,  // Reverted: Use suggestedMin
                    suggestedMax: max,  // Reverted: Use suggestedMax
                    ticks: {
                        color: "#ccc",
                        // Removed stepSize: calculateStepSize(max)
                        padding: 10, // from a previous working version
                        maxTicksLimit: 7, // from a previous working version
                        callback: function(value) {
                            let formattedValue = value;
                            if (typeof value === 'number') {
                                formattedValue = value.toFixed(2);
                            }
                            return formattedValue + (yAxisLabel ? ` ${yAxisLabel}` : "");
                        }
                    },
                    grid: { 
                        color: "rgba(255,255,255,0.1)",
                        drawBorder: false // from a previous working version
                    },
                    border: { 
                        display: true,
                        color: '#ccc'
                    },
                    title: { // from a previous working version
                        display: true,
                        text: yAxisLabel,
                        color: '#ccc',
                        font: {
                            size: 14,
                            weight: 'bold'
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    // display: false // Kept as per user's current file state - User might have this for a reason
                    // Reverting to a previously working state for legend for now
                     labels: {
                       color: "#ccc",
                     },
                },
                tooltip: {
                    mode: 'index', // from a previous working version
                    intersect: false, // from a previous working version
                    backgroundColor: 'rgba(0,0,0,0.8)', // from a previous working version
                    titleColor: '#fff', // from a previous working version
                    bodyColor: '#fff', // from a previous working version
                    borderColor: lineColor, // from a previous working version
                    borderWidth: 1, // from a previous working version
                    padding: 10, // from a previous working version
                    cornerRadius: 4, // from a previous working version
                    callbacks: {
                        label: function(context) {
                            // Use yAxisLabel from the chart's y-axis title for units
                            const unitLabel = context.chart.options.scales.y.title.text || '';
                            return `${context.dataset.label}: ${context.parsed.y}${unitLabel ? ' ' + unitLabel : ''}`;
                        }
                    }
                }
            },
            animation: { // from a previous working version
              duration: 800, 
              easing: 'easeInOutQuad' 
            }
        }
        });
}

// Helper function to calculate stepSize for y-axis ticks // REMOVE THIS FUNCTION
// function calculateStepSize(maxValue) {
// if (maxValue <= 10) return 2;
// if (maxValue <= 20) return 5;
// return Math.ceil(maxValue / 5);
// }

      /************************************************************
       * Global variables to store records for CSV download
       ************************************************************/
      let starlinkRecords = [];
      let wifiRecords = [];

      /************************************************************
       * Process and display data in the UI
       ************************************************************/
      function processAndDisplayData(data) {
        /************************************************************
         * WIFI (Router) Charts
         ************************************************************/
        const routerData = data.telemetry_data?.router || {};
        wifiRecords = routerData.allRecords || []; // store globally for CSV

        if (wifiRecords.length > 0) {
          // Build time labels for Wi-Fi
          const wifiTimeLabels = wifiRecords.map((r) => {
            const d = new Date(r.timestamp);
            // Changed to 24-hour format to remove AM/PM
            return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false });
          });

          // If your actual fields differ, adjust these lines:
          const wifiLatencyValues = wifiRecords.map((r) => r.InternetPingLatencyMs || 0);
          const wifiPingDropValues = wifiRecords.map((r) => (r.InternetPingDropRate || 0) * 100);

          // Helper to find min, max, last
          function calcMinMaxLast(arr) {
            if (!arr.length) return { min: 0, max: 0, last: 0 };
            const min = Math.min(...arr);
            const max = Math.max(...arr);
            const last = arr[arr.length - 1];
            return { min, max, last };
          }

          const latStats = calcMinMaxLast(wifiLatencyValues);
          const dropStats = calcMinMaxLast(wifiPingDropValues);

          // Update chart-stats text
          document.getElementById("wifiLatencyStats").textContent =
            `Min ${latStats.min.toFixed(0)}ms · Max ${latStats.max.toFixed(0)}ms · Last ${latStats.last.toFixed(0)}ms`;

          document.getElementById("wifiPingDropStats").textContent =
            `Min ${dropStats.min.toFixed(2)}% · Max ${dropStats.max.toFixed(2)}% · Last ${dropStats.last.toFixed(2)}%`;

          // Destroy old chart instances if they exist
          if (window.wifiLatencyChartInstance) window.wifiLatencyChartInstance.destroy();
          if (window.wifiPingDropChartInstance) window.wifiPingDropChartInstance.destroy();

          // Create new charts for Wi-Fi
          const wifiLatencyCtx = document.getElementById("wifiLatencyChart").getContext("2d");
          window.wifiLatencyChartInstance = createLineChart(
            wifiLatencyCtx,
            "Latency (ms)",
            wifiTimeLabels,
            wifiLatencyValues,
            "ms"
          );

          const wifiPingDropCtx = document.getElementById("wifiPingDropChart").getContext("2d");
          window.wifiPingDropChartInstance = createLineChart(
            wifiPingDropCtx,
            "Ping Drop (%)",
            wifiTimeLabels,
            wifiPingDropValues,
            "%"
          );
          const statusSpan = document.getElementById("serviceStatus");
            if (typeof data.active === "boolean") {
              if (data.active) {
                statusSpan.textContent = "Active";
                statusSpan.style.color = "#22c55e"; // green
              } else {
                statusSpan.textContent = "Inactive";
                statusSpan.style.color = "#ef4444"; // red
              }
            } else {
              statusSpan.textContent = "Unknown";
              statusSpan.style.color = "#ccc";
}
        }

        /************************************************************
         * Billing Data (Usage Chart)
         ************************************************************/
        if (data.dataUsage && data.dataUsage.length > 0) {
          loadBillingData(data.dataUsage[0]);
          document.getElementById("billingDataBox").style.display = "block";
        } else {
          document.getElementById("billingDataBox").style.display = "none";
        }

        // Address and map
        const addressElement = document.querySelector(".box-address");
        if (data.formattedAddress) {
          addressElement.textContent = data.formattedAddress;
          initializeMap(data.formattedAddress);
        } else {
          addressElement.textContent = "Address not available";
        }

        // Subscription/device details
        document.querySelector(".subscription-id").textContent =
          data.nickname || "N/A";
        document.querySelector(".box-nickname").textContent =
          data.nickname || "N/A";

        document.getElementById("starlinkId").textContent =
          data.userTerminalId || "N/A";
        document.getElementById("starlinkSw").textContent =
          data.user_terminal_software_version || "N/A";
        document.getElementById("dishSerial").textContent =
          data.dishSerialNumber || "N/A";
        document.getElementById("kitSerial").textContent =
          data.kitSerialNumber || "N/A";
        document.getElementById("routerId").textContent =
          data.routerId || "N/A";
        document.getElementById("routerSw").textContent =
          data.router_software_version || "N/A";

        /************************************************************
         * STARLINK (User Terminal) Charts
         ************************************************************/
        const userTerminalData = data.telemetry_data?.userTerminal || {};
        starlinkRecords = userTerminalData.allRecords || []; // store globally for CSV

        if (!starlinkRecords.length) {
          console.log("No starlink records found.");
          return;
        }

        // Build time labels for Starlink
        const starlinkTimeLabels = starlinkRecords.map((r) => {
          const d = new Date(r.timestamp);
          // Changed to 24-hour format to remove AM/PM
          return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false });
        });

        // Extract Starlink metrics
        const downlinkValues = starlinkRecords.map((r) => r.DownlinkThroughput || 0);
        const uplinkValues   = starlinkRecords.map((r) => r.UplinkThroughput || 0);
        const latencyValues  = starlinkRecords.map((r) => r.PingLatencyMsAvg || 0);
        const pingDropValues = starlinkRecords.map((r) => (r.PingDropRateAvg || 0) * 100);
        const signalValues   = starlinkRecords.map((r) => (r.SignalQuality || 0) * 100);
        const obstructionValues = starlinkRecords.map((r) => (r.ObstructionPercentTime || 0) * 100);

        // Helper for min/max/last
        function calcMinMaxLast(arr) {
          const min = Math.min(...arr);
          const max = Math.max(...arr);
          const last = arr[arr.length - 1];
          return { min, max, last };
        }

        // Calculate stats
        const dl = calcMinMaxLast(downlinkValues);
        const ul = calcMinMaxLast(uplinkValues);
        const lt = calcMinMaxLast(latencyValues);
        const pd = calcMinMaxLast(pingDropValues);
        const sq = calcMinMaxLast(signalValues);
        const ob = calcMinMaxLast(obstructionValues);

        // Update Starlink chart stats
        document.getElementById("downlinkStats").textContent =
          `Min ${dl.min.toFixed(2)} Mbps · Max ${dl.max.toFixed(2)} Mbps · Last ${dl.last.toFixed(2)} Mbps`;
        document.getElementById("uplinkStats").textContent =
          `Min ${ul.min.toFixed(2)} Mbps · Max ${ul.max.toFixed(2)} Mbps · Last ${ul.last.toFixed(2)} Mbps`;
        document.getElementById("latencyStats").textContent =
          `Min ${lt.min.toFixed(0)} ms · Max ${lt.max.toFixed(0)} ms · Last ${lt.last.toFixed(0)} ms`;
        document.getElementById("pingDropStats").textContent =
          `Min ${pd.min.toFixed(2)}% · Max ${pd.max.toFixed(2)}% · Last ${pd.last.toFixed(2)}%`;
        document.getElementById("signalStats").textContent =
          `Min ${sq.min.toFixed(0)}% · Max ${sq.max.toFixed(0)}% · Last ${sq.last.toFixed(0)}%`;
        document.getElementById("obstructionStats").textContent =
          `Min ${ob.min.toFixed(2)}% · Max ${ob.max.toFixed(2)}% · Last ${ob.last.toFixed(2)}%`;

        // Destroy old Starlink chart instances if they exist
        if (window.downlinkChartInstance)   window.downlinkChartInstance.destroy();
        if (window.uplinkChartInstance)     window.uplinkChartInstance.destroy();
        if (window.latencyChartInstance)    window.latencyChartInstance.destroy();
        if (window.pingDropChartInstance)   window.pingDropChartInstance.destroy();
        if (window.signalChartInstance)     window.signalChartInstance.destroy();
        if (window.obstructionChartInstance)window.obstructionChartInstance.destroy();

        // Create Starlink charts with different colors
        const downlinkCtx = document.getElementById("downlinkChart").getContext("2d");
        window.downlinkChartInstance = createLineChart(
          downlinkCtx, "Downlink (Mbps)", starlinkTimeLabels, downlinkValues, "Mbps", "#0ea5e9"
        );

        const uplinkCtx = document.getElementById("uplinkChart").getContext("2d");
        window.uplinkChartInstance = createLineChart(
          uplinkCtx, "Uplink (Mbps)", starlinkTimeLabels, uplinkValues, "Mbps", "#8b5cf6"
        );

        const latencyCtx = document.getElementById("latencyChart").getContext("2d");
        window.latencyChartInstance = createLineChart(
          latencyCtx, "Latency (ms)", starlinkTimeLabels, latencyValues, "ms", "#10b981"
        );

        const pingDropCtx = document.getElementById("pingDropChart").getContext("2d");
        window.pingDropChartInstance = createLineChart(
          pingDropCtx, "Ping Drop (%)", starlinkTimeLabels, pingDropValues, "%", "#ef4444"
        );

        const signalCtx = document.getElementById("signalChart").getContext("2d");
        window.signalChartInstance = createLineChart(
          signalCtx, "Signal Quality (%)", starlinkTimeLabels, signalValues, "%", "#f59e0b"
        );

        const obstructionCtx = document.getElementById("obstructionChart").getContext("2d");
        window.obstructionChartInstance = createLineChart(
          obstructionCtx, "Obstruction (%)", starlinkTimeLabels, obstructionValues, "%", "#6366f1"
        );
      }

      /************************************************************
       * Billing data: usage chart logic
       ************************************************************/
      function loadBillingData(serviceLineData) {
        const monthTabsContainer = document.getElementById("monthTabs");
        monthTabsContainer.innerHTML = "";
        const monthlyData = {};
        const billingCycles = serviceLineData.billingCycles || [];

        for (const cycle of billingCycles) {
          const cycleEnd = new Date(cycle.endDate);
          const eightMonthsAgo = new Date();
          eightMonthsAgo.setMonth(eightMonthsAgo.getMonth() - 8);
          if (cycleEnd < eightMonthsAgo) continue;

          const label = cycleLabel(cycle.startDate, cycle.endDate);
          const usageArray = cycle.dailyDataUsage.map((d) => ({
            standard: parseFloat(d.standardGB) || 0,
            priority: parseFloat(d.priorityGB) || 0,
            nonBillable: parseFloat(d.nonBillableGB) || 0,
            optIn: parseFloat(d.optInPriorityGB) || 0,
          }));
          monthlyData[label] = usageArray;
          createCycleTab(label, monthlyData);
        }
      }

      function cycleLabel(startDateStr, endDateStr) {
        const start = new Date(startDateStr);
        const end = new Date(endDateStr);
        const opts = { month: "short" };
        return `${start.toLocaleDateString("en-US", opts)} - ${end.toLocaleDateString(
          "en-US",
          opts
        )}`;
      }

      function createCycleTab(label, monthlyData) {
        const tab = document.createElement("span");
        tab.classList.add("month-tab");
        tab.innerText = label;
        tab.addEventListener("click", () => {
          document
            .querySelectorAll(".month-tab")
            .forEach((el) => el.classList.remove("active"));
          tab.classList.add("active");
          updateChart(label, monthlyData);
        });
        document.getElementById("monthTabs").appendChild(tab);
        if (document.querySelectorAll(".month-tab").length === 1) {
          tab.classList.add("active");
          updateChart(label, monthlyData);
        }
      }

      function updateChart(label, monthlyData) {
        const dailyArray = monthlyData[label] || [];
        usageChart.data.labels = dailyArray.map((_, i) => "Day " + (i + 1));
        usageChart.data.datasets[0].data = dailyArray.map((item) => item.standard);
        usageChart.data.datasets[1].data = dailyArray.map((item) => item.priority);
        usageChart.data.datasets[2].data = dailyArray.map((item) => item.nonBillable);
        usageChart.data.datasets[3].data = dailyArray.map((item) => item.optIn);

        let cycleSum = dailyArray.reduce(
          (sum, day) =>
            sum + (day.standard + day.priority + day.nonBillable + day.optIn),
          0
        );
        document.querySelector(".box-total-usage").textContent =
          cycleSum.toFixed(2) + " GB";
        document.getElementById("legendTotal").textContent =
          cycleSum.toFixed(2) + " GB";
        usageChart.update();
      }

      /************************************************************
       * Chart.js config for usageChart (billing data)
       ************************************************************/
      const usageChartCtx = document.getElementById("usageChart").getContext("2d");
      const usageChart = new Chart(usageChartCtx, {
        type: "bar",
        data: {
          labels: [],
          datasets: [
            {
              label: "Standard Data",
              data: [],
              backgroundColor: "#1E90FF",
              borderWidth: 1,
            },
            {
              label: "Priority Data",
              data: [],
              backgroundColor: "#FFC107",
              borderWidth: 1,
            },
            {
              label: "Non-Billable",
              data: [],
              backgroundColor: "#2ecc71",
              borderWidth: 1,
            },
            {
              label: "Opt-In Priority",
              data: [],
              backgroundColor: "#FF5733",
              borderWidth: 1,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              ticks: { color: "#ccc" },
              grid: { color: "rgba(255,255,255,0.2)" },
            },
            x: {
              ticks: { color: "#ccc" },
              grid: { color: "rgba(255,255,255,0.2)" },
            },
          },
          plugins: {
            tooltip: {
              backgroundColor: "rgba(0,0,0,0.7)",
              titleColor: "#fff",
              bodyColor: "#fff",
              borderColor: "#fff",
              borderWidth: 1,
            },
            legend: {
              labels: { color: "#ccc" },
            },
          },
        },
      });

      /************************************************************
       * On DOMContentLoaded: Check authentication, fetch data
       ************************************************************/
      window.addEventListener("DOMContentLoaded", async () => {
        const idToken = sessionStorage.getItem("idToken");
        const rawServiceLines = sessionStorage.getItem("serviceLines");
        if (!idToken || !rawServiceLines) {
          alert("No login data found. Please log in first.");
          window.location.href = "login.html";
          return;
        }

        const serviceLines = JSON.parse(rawServiceLines);

        // Populate dropdown using the serviceLines array.
        populateServiceLineDropdownFromServiceLines(serviceLines);

        // Fetch dashboard data for the first service line.
        try {
          const dashboardData = await fetchDashboardData(serviceLines[0], idToken);
          sessionStorage.setItem("dashboardData", JSON.stringify(dashboardData));
          processAndDisplayData(dashboardData);
        } catch (error) {
          alert("Error loading initial data: " + error.message);
        }
      });

      /************************************************************
       * Populate the service line dropdown from serviceLines
       ************************************************************/
      function populateServiceLineDropdownFromServiceLines(serviceLines) {
        const dropdown = document.getElementById("serviceLineDropdown");
        dropdown.innerHTML = "";

        serviceLines.forEach((line) => {
          const option = document.createElement("option");
          option.value = line;
          option.textContent = line;
          dropdown.appendChild(option);
        });

        if (serviceLines.length > 1) {
          document.getElementById("serviceLineWrapper").style.display = "block";
        }

        // On change, fetch new data for the selected service line.
        dropdown.addEventListener("change", async (e) => {
          const selectedLine = e.target.value;
          try {
            const idToken = sessionStorage.getItem("idToken");
            const dashboardData = await fetchDashboardData(selectedLine, idToken);
            sessionStorage.setItem("dashboardData", JSON.stringify(dashboardData));
            processAndDisplayData(dashboardData);
          } catch (error) {
            alert("Error loading data for selected service line: " + error.message);
          }
        });
      }
    </script>

    <script>
      /*****************************
       * Device Panel Toggle Logic
       *****************************/
      const starlinkPanel = document.getElementById("starlinkPanel");
      const wifiPanel = document.getElementById("wifiPanel");
      const btnStarlink = document.getElementById("btn-starlink");
      const btnWifi = document.getElementById("btn-wifi");

      starlinkPanel.style.display = "block";
      wifiPanel.style.display = "none";

      btnStarlink.addEventListener("click", () => {
        starlinkPanel.style.display = "block";
        wifiPanel.style.display = "none";
      });
      btnWifi.addEventListener("click", () => {
        starlinkPanel.style.display = "none";
        wifiPanel.style.display = "block";
      });

      /*****************************
       * Expand/Collapse Logic
       *****************************/
      const starlinkExpandBtn = document.getElementById("starlinkExpandBtn");
      const starlinkChartGrid = document.querySelector("#starlinkPanel .chart-grid");
      starlinkExpandBtn.addEventListener("click", () => {
        if (starlinkChartGrid.classList.contains("expanded")) {
          starlinkChartGrid.classList.remove("expanded");
          starlinkExpandBtn.textContent = "Expand Charts";
        } else {
          starlinkChartGrid.classList.add("expanded");
          starlinkExpandBtn.textContent = "Collapse Charts";
        }
      });

      const wifiExpandBtn = document.getElementById("wifiExpandBtn");
      const wifiChartGrid = document.querySelector("#wifiPanel .chart-grid");
      wifiExpandBtn.addEventListener("click", () => {
        if (wifiChartGrid.classList.contains("expanded")) {
          wifiChartGrid.classList.remove("expanded");
          wifiExpandBtn.textContent = "Expand Charts";
        } else {
          wifiChartGrid.classList.add("expanded");
          wifiExpandBtn.textContent = "Collapse Charts";
        }
      });

      /*****************************
       * Download CSV Logic
       *****************************/
      const starlinkDownloadBtn = document.getElementById("starlinkDownloadCsvBtn");
      starlinkDownloadBtn.addEventListener("click", () => {
        if (!window.starlinkRecords || !window.starlinkRecords.length) {
          alert("No Starlink data available to download.");
          return;
        }
        // Build CSV from starlinkRecords
        let csv = "timestamp,DownlinkThroughput,UplinkThroughput,PingLatencyMsAvg,PingDropRateAvg,SignalQuality,ObstructionPercentTime\n";
        window.starlinkRecords.forEach(r => {
          csv += `"${r.timestamp}",${r.DownlinkThroughput || ""},${r.UplinkThroughput || ""},${r.PingLatencyMsAvg || ""},${r.PingDropRateAvg || ""},${r.SignalQuality || ""},${r.ObstructionPercentTime || ""}\n`;
        });

        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "starlink_data.csv";
        a.click();
        URL.revokeObjectURL(url);
      });

      const wifiDownloadBtn = document.getElementById("wifiDownloadCsvBtn");
      wifiDownloadBtn.addEventListener("click", () => {
        if (!window.wifiRecords || !window.wifiRecords.length) {
          alert("No Wi-Fi data available to download.");
          return;
        }
        // Build CSV from wifiRecords
        // Adjust field names if your real router fields differ
        let csv = "timestamp,InternetPingLatencyMs,InternetPingDropRate\n";
        window.wifiRecords.forEach(r => {
          csv += `"${r.timestamp}",${r.InternetPingLatencyMs || ""},${r.InternetPingDropRate || ""}\n`;
        });

        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "wifi_data.csv";
        a.click();
        URL.revokeObjectURL(url);
      });

      document.getElementById('logoutBtn').addEventListener('click', function() {
        // Optionally clear any local/session storage if used for auth
        window.location.href = 'login.html';
      });
    </script>
  </body>
</html>
